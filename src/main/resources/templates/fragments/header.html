<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>
<header th:fragment="headerFragment" class="main-header">
    <div class="header-wrapper">
        <div class="header-top">
            <!-- LOGO -->
            <div class="logo">
                <a th:href="@{/}">ë¯¸ì§„ì»´í¼ë‹ˆ</a>
            </div>

            <!-- SEARCH BAR -->
            <div class="search-bar">
                <form th:action="@{/products}" method="get">
                    <input type="text" name="keyword" placeholder="ê´€ì‹¬ìˆëŠ” ë‚´ìš©ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”!">
                    <button type="submit">ğŸ”</button>
                </form>
            </div>

            <!-- RIGHT MENU: ACTIONS & USER-AUTH -->
            <div class="right-menu">
                <a sec:authorize="isAuthenticated()" th:href="@{/products/new}">ê¸€ì“°ê¸°</a>
                <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin}">Admin</a>
                <a sec:authorize="isAuthenticated()" th:href="@{/mypage}">ë§ˆì´í˜ì´ì§€</a>

                <span class="separator">|</span>

                <div class="user-auth-links">
                    <!-- For anonymous users -->
                    <div sec:authorize="isAnonymous()" class="auth-block">
                        <a th:href="@{/users/login}">ë¡œê·¸ì¸</a>
                        <a th:href="@{/users/new}">íšŒì›ê°€ì…</a>
                    </div>

                    <!-- For authenticated users -->
                    <div sec:authorize="isAuthenticated()" class="auth-block">
                        <span class="user-info" th:if="${session.user != null}" th:text="${session.user.nickname}"></span><span class="user-info">ë‹˜</span>
                        <a th:href="@{/users/{id}(id=${session.user.id})}">ë‚´ ì •ë³´</a>
                        <a href="javascript:void(0)" onclick="toggleChatOverlay()" id="chat-btn">ì±„íŒ…</a>
                        <form th:action="@{/users/logout}" method="post">
                            <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <nav class="header-nav">
            <ul>
                <li class="category-dropdown-container">
                    <a href="#" class="category-trigger">ì¹´í…Œê³ ë¦¬</a>
                    <div class="category-dropdown">
                        <!-- 1. ì¢Œì¸¡: ëŒ€ë¶„ë¥˜ ì‚¬ì´ë“œë°” -->
                        <div class="category-sidebar">
                            <div th:each="category, stat : ${headerCategories}"
                                 class="sidebar-item"
                                 th:classappend="${stat.first} ? 'active'"
                                 th:text="${category.name}"
                                 th:onmouseover="'showSubCategory(' + ${category.id} + ', this)'">
                                 ì¹´í…Œê³ ë¦¬ëª…
                            </div>
                            <div th:if="${headerCategories == null or #lists.isEmpty(headerCategories)}" 
                                 style="padding: 15px; color: #999; font-size: 13px;">
                                ì¹´í…Œê³ ë¦¬ ì—†ìŒ
                            </div>
                        </div>

                        <!-- 2. ìš°ì¸¡: ì†Œë¶„ë¥˜ ì½˜í…ì¸  -->
                        <div class="category-content">
                            <div th:each="category, stat : ${headerCategories}"
                                 th:id="'sub-group-' + ${category.id}"
                                 class="sub-category-group"
                                 th:classappend="${stat.first} ? 'active'">
                                
                                <!-- ì†Œë¶„ë¥˜ ì œëª© (í´ë¦­ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰) -->
                                <div class="sub-category-title">
                                    <a th:href="@{/products(categoryId=${category.id})}" 
                                       th:text="${category.name} + ' ì „ì²´ë³´ê¸°'" 
                                       style="text-decoration: none; color: inherit;">
                                        ì¹´í…Œê³ ë¦¬ëª…
                                    </a>
                                </div>

                                <!-- ì†Œë¶„ë¥˜ ë¦¬ìŠ¤íŠ¸ -->
                                <div class="sub-category-list">
                                    <a th:each="child : ${category.children}"
                                       th:href="@{/products(categoryId=${child.id})}"
                                       class="sub-category-item"
                                       th:text="${child.name}">
                                       ì†Œë¶„ë¥˜ëª…
                                    </a>
                                    <p th:if="${#lists.isEmpty(category.children)}" style="color: #999; font-size: 13px;">í•˜ìœ„ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JS: ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ìš°ì¸¡ íŒ¨ë„ ë³€ê²½ -->
                    <script>
                        function showSubCategory(categoryId, element) {
                            // 1. ëª¨ë“  ì‚¬ì´ë“œë°” ì•„ì´í…œì˜ active ì œê±°
                            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                            // 2. í˜„ì¬ ì„ íƒëœ ì•„ì´í…œ active ì¶”ê°€
                            element.classList.add('active');

                            // 3. ëª¨ë“  ì„œë¸Œ ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ ìˆ¨ê¸°ê¸°
                            document.querySelectorAll('.sub-category-group').forEach(group => group.classList.remove('active'));
                            // 4. í•´ë‹¹í•˜ëŠ” ì„œë¸Œ ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ ë³´ì´ê¸°
                            const targetGroup = document.getElementById('sub-group-' + categoryId);
                            if(targetGroup) {
                                targetGroup.classList.add('active');
                            }
                        }
                    </script>
                </li>
                <li><a href="#" id="wishlist-btn">ì°œí•œ ìƒí’ˆ</a></li>
                <li><a href="#">ì„ì‹œë©”ë‰´</a></li>
                <li><a href="#">ì¶”ê°€ë©”ë‰´</a></li>
                <li><a href="#">í…ŒìŠ¤íŠ¸</a></li>
            </ul>
        </nav>
    </div>

    <!-- Wishlist Sidebar & Overlay -->
    <div id="wishlist-overlay" class="wishlist-overlay"></div>
    <div id="wishlist-sidebar" class="wishlist-sidebar">
        <div class="sidebar-header">
            <h2>ì°œí•œ ìƒí’ˆ</h2>
            <button id="close-wishlist" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <!-- ì—¬ê¸°ì— ì°œí•œ ìƒí’ˆ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë˜ê±°ë‚˜ í‘œì‹œë©ë‹ˆë‹¤ -->
            <p>ì°œí•œ ìƒí’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Wishlist Logic ---
            const wishlistBtn = document.getElementById('wishlist-btn');
            const wishlistOverlay = document.getElementById('wishlist-overlay');
            const wishlistSidebar = document.getElementById('wishlist-sidebar');
            const closeWishlistBtn = document.getElementById('close-wishlist');
            const wishlistContent = document.querySelector('.sidebar-content');

            function openWishlist(e) {
                e.preventDefault();
                wishlistOverlay.classList.add('active');
                wishlistSidebar.classList.add('active');
                loadWishList();
            }

            function closeWishlist() {
                wishlistOverlay.classList.remove('active');
                wishlistSidebar.classList.remove('active');
            }

            function loadWishList() {
                wishlistContent.innerHTML = '<p style="padding: 20px;">ë¡œë”© ì¤‘...</p>';
                fetch('/api/wishlist')
                    .then(response => {
                        if (response.status === 401) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        if (!response.ok) throw new Error('ë°ì´í„° ì˜¤ë¥˜');
                        return response.json();
                    })
                    .then(products => {
                        if (products.length === 0) {
                            wishlistContent.innerHTML = '<p style="padding: 20px;">ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                            return;
                        }
                        let html = '<ul class="wishlist-items">';
                        products.forEach(product => {
                            html += `
                                <li class="wishlist-item">
                                    <a href="/products/${product.id}" class="wishlist-link">
                                        <img src="${product.thumbnailUrl}" alt="${product.title}" class="wishlist-thumb">
                                        <div class="wishlist-info">
                                            <p class="wishlist-title">${product.title}</p>
                                            <p class="wishlist-price">${product.price.toLocaleString()}ì›</p>
                                        </div>
                                    </a>
                                </li>
                            `;
                        });
                        html += '</ul>';
                        wishlistContent.innerHTML = html;
                    })
                    .catch(error => {
                        if (error.message === 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.') {
                            wishlistContent.innerHTML = '<p style="padding: 20px;"><a href="/users/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                        } else {
                            wishlistContent.innerHTML = '<p style="padding: 20px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
                        }
                    });
            }

            if(wishlistBtn) wishlistBtn.addEventListener('click', openWishlist);
            if(closeWishlistBtn) closeWishlistBtn.addEventListener('click', closeWishlist);
            if(wishlistOverlay) wishlistOverlay.addEventListener('click', closeWishlist);
        });
    </script>
</header>
</body>
</html>