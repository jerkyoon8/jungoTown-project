<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>
<header th:fragment="headerFragment" class="main-header">
    <div class="header-wrapper">
        <div class="header-top">
            <!-- LOGO -->
            <div class="logo">
                <a th:href="@{/}">ë¯¸ì§„ì»´í¼ë‹ˆ</a>
            </div>

            <!-- SEARCH BAR -->
            <div class="search-bar">
                <form th:action="@{/products}" method="get">
                    <input type="text" name="keyword" placeholder="ê´€ì‹¬ìˆëŠ” ë‚´ìš©ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”!">
                    <button type="submit">ğŸ”</button>
                </form>
            </div>

            <!-- RIGHT MENU: ACTIONS & USER-AUTH -->
            <div class="right-menu">
                <a sec:authorize="isAuthenticated()" th:href="@{/products/new}">ê¸€ì“°ê¸°</a>
                <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin}">Admin</a>
                <a sec:authorize="isAuthenticated()" th:href="@{/mypage}">ë§ˆì´í˜ì´ì§€</a>

                <span class="separator">|</span>

                <div class="user-auth-links">
                    <!-- For anonymous users -->
                    <div sec:authorize="isAnonymous()" class="auth-block">
                        <a th:href="@{/users/login}">ë¡œê·¸ì¸</a>
                        <a th:href="@{/users/new}">íšŒì›ê°€ì…</a>
                    </div>

                    <!-- For authenticated users -->
                    <div sec:authorize="isAuthenticated()" class="auth-block">
                        <span class="user-info" th:if="${session.user != null}" th:text="${session.user.nickname}"></span><span class="user-info">ë‹˜</span>
                        <a th:href="@{/users/{id}(id=${session.user.id})}">ë‚´ ì •ë³´</a>
                        <a href="#" id="chat-btn">ì±„íŒ…</a>
                        <form th:action="@{/users/logout}" method="post">
                            <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <nav class="header-nav">
            <ul>
                <li class="category-dropdown-container">
                    <a href="#" class="category-trigger">ì¹´í…Œê³ ë¦¬</a>
                    <div class="category-dropdown">
                        <!-- 1. ì¢Œì¸¡: ëŒ€ë¶„ë¥˜ ì‚¬ì´ë“œë°” -->
                        <div class="category-sidebar">
                            <div th:each="category, stat : ${headerCategories}"
                                 class="sidebar-item"
                                 th:classappend="${stat.first} ? 'active'"
                                 th:text="${category.name}"
                                 th:onmouseover="'showSubCategory(' + ${category.id} + ', this)'">
                                 ì¹´í…Œê³ ë¦¬ëª…
                            </div>
                            <div th:if="${headerCategories == null or #lists.isEmpty(headerCategories)}" 
                                 style="padding: 15px; color: #999; font-size: 13px;">
                                ì¹´í…Œê³ ë¦¬ ì—†ìŒ
                            </div>
                        </div>

                        <!-- 2. ìš°ì¸¡: ì†Œë¶„ë¥˜ ì½˜í…ì¸  -->
                        <div class="category-content">
                            <div th:each="category, stat : ${headerCategories}"
                                 th:id="'sub-group-' + ${category.id}"
                                 class="sub-category-group"
                                 th:classappend="${stat.first} ? 'active'">
                                
                                <!-- ì†Œë¶„ë¥˜ ì œëª© (í´ë¦­ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰) -->
                                <div class="sub-category-title">
                                    <a th:href="@{/products(categoryId=${category.id})}" 
                                       th:text="${category.name} + ' ì „ì²´ë³´ê¸°'" 
                                       style="text-decoration: none; color: inherit;">
                                        ì¹´í…Œê³ ë¦¬ëª…
                                    </a>
                                </div>

                                <!-- ì†Œë¶„ë¥˜ ë¦¬ìŠ¤íŠ¸ -->
                                <div class="sub-category-list">
                                    <a th:each="child : ${category.children}"
                                       th:href="@{/products(categoryId=${child.id})}"
                                       class="sub-category-item"
                                       th:text="${child.name}">
                                       ì†Œë¶„ë¥˜ëª…
                                    </a>
                                    <p th:if="${#lists.isEmpty(category.children)}" style="color: #999; font-size: 13px;">í•˜ìœ„ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- JS: ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ìš°ì¸¡ íŒ¨ë„ ë³€ê²½ -->
                    <script>
                        function showSubCategory(categoryId, element) {
                            // 1. ëª¨ë“  ì‚¬ì´ë“œë°” ì•„ì´í…œì˜ active ì œê±°
                            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
                            // 2. í˜„ì¬ ì„ íƒëœ ì•„ì´í…œ active ì¶”ê°€
                            element.classList.add('active');

                            // 3. ëª¨ë“  ì„œë¸Œ ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ ìˆ¨ê¸°ê¸°
                            document.querySelectorAll('.sub-category-group').forEach(group => group.classList.remove('active'));
                            // 4. í•´ë‹¹í•˜ëŠ” ì„œë¸Œ ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ ë³´ì´ê¸°
                            const targetGroup = document.getElementById('sub-group-' + categoryId);
                            if(targetGroup) {
                                targetGroup.classList.add('active');
                            }
                        }
                    </script>
                </li>
                <li><a href="#" id="wishlist-btn">ì°œí•œ ìƒí’ˆ</a></li>
                <li><a href="#">ì„ì‹œë©”ë‰´</a></li>
                <li><a href="#">ì¶”ê°€ë©”ë‰´</a></li>
                <li><a href="#">í…ŒìŠ¤íŠ¸</a></li>
            </ul>
        </nav>
    </div>

    <!-- Wishlist Sidebar & Overlay -->
    <div id="wishlist-overlay" class="wishlist-overlay"></div>
    <div id="wishlist-sidebar" class="wishlist-sidebar">
        <div class="sidebar-header">
            <h2>ì°œí•œ ìƒí’ˆ</h2>
            <button id="close-wishlist" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <!-- ì—¬ê¸°ì— ì°œí•œ ìƒí’ˆ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë˜ê±°ë‚˜ í‘œì‹œë©ë‹ˆë‹¤ -->
            <p>ì°œí•œ ìƒí’ˆ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- Chat Sidebar & Overlay -->
    <div id="chat-overlay" class="chat-overlay"></div>
    <div id="chat-sidebar" class="chat-sidebar">
        <!-- Chat List View -->
        <div id="chat-list-view">
            <div class="sidebar-header">
                <h2>ì±„íŒ… ëª©ë¡</h2>
                <button id="close-chat" class="close-btn">&times;</button>
            </div>
            <div class="sidebar-content" id="chat-list-content">
                <p style="padding: 20px;">ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <!-- Chat Room View (Hidden by default) -->
        <div id="chat-room-view" style="display: none; height: 100%; flex-direction: column;">
            <div class="sidebar-header">
                <div style="display: flex; align-items: center;">
                    <button id="back-to-chat-list" class="back-to-list-btn">â†</button>
                    <h2 id="current-chat-title">ì±„íŒ…ë°©</h2>
                </div>
                <button id="close-chat-room" class="close-btn">&times;</button>
            </div>
            <div class="chat-messages-area" id="chat-messages-area">
                <!-- Messages will be loaded here -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                <button id="send-chat-btn" class="chat-send-btn">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Wishlist Logic ---
            const wishlistBtn = document.getElementById('wishlist-btn');
            const wishlistOverlay = document.getElementById('wishlist-overlay');
            const wishlistSidebar = document.getElementById('wishlist-sidebar');
            const closeWishlistBtn = document.getElementById('close-wishlist');
            const wishlistContent = document.querySelector('.sidebar-content');

            function openWishlist(e) {
                e.preventDefault();
                wishlistOverlay.classList.add('active');
                wishlistSidebar.classList.add('active');
                loadWishList();
            }

            function closeWishlist() {
                wishlistOverlay.classList.remove('active');
                wishlistSidebar.classList.remove('active');
            }

            function loadWishList() {
                wishlistContent.innerHTML = '<p style="padding: 20px;">ë¡œë”© ì¤‘...</p>';
                fetch('/api/wishlist')
                    .then(response => {
                        if (response.status === 401) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        if (!response.ok) throw new Error('ë°ì´í„° ì˜¤ë¥˜');
                        return response.json();
                    })
                    .then(products => {
                        if (products.length === 0) {
                            wishlistContent.innerHTML = '<p style="padding: 20px;">ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                            return;
                        }
                        let html = '<ul class="wishlist-items">';
                        products.forEach(product => {
                            html += `
                                <li class="wishlist-item">
                                    <a href="/products/${product.id}" class="wishlist-link">
                                        <img src="${product.thumbnailUrl}" alt="${product.title}" class="wishlist-thumb">
                                        <div class="wishlist-info">
                                            <p class="wishlist-title">${product.title}</p>
                                            <p class="wishlist-price">${product.price.toLocaleString()}ì›</p>
                                        </div>
                                    </a>
                                </li>
                            `;
                        });
                        html += '</ul>';
                        wishlistContent.innerHTML = html;
                    })
                    .catch(error => {
                        if (error.message === 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.') {
                            wishlistContent.innerHTML = '<p style="padding: 20px;"><a href="/users/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>';
                        } else {
                            wishlistContent.innerHTML = '<p style="padding: 20px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
                        }
                    });
            }

            if(wishlistBtn) wishlistBtn.addEventListener('click', openWishlist);
            if(closeWishlistBtn) closeWishlistBtn.addEventListener('click', closeWishlist);
            if(wishlistOverlay) wishlistOverlay.addEventListener('click', closeWishlist);


            // --- Chat Overlay Logic ---
            const chatBtn = document.getElementById('chat-btn');
            const chatOverlay = document.getElementById('chat-overlay');
            const chatSidebar = document.getElementById('chat-sidebar');
            const closeChatBtn = document.getElementById('close-chat');
            const closeChatRoomBtn = document.getElementById('close-chat-room');
            const chatListContent = document.getElementById('chat-list-content');
            const chatListView = document.getElementById('chat-list-view');
            const chatRoomView = document.getElementById('chat-room-view');
            const backToChatListBtn = document.getElementById('back-to-chat-list');
            const chatMessagesArea = document.getElementById('chat-messages-area');
            const chatInput = document.getElementById('chat-input');
            const sendChatBtn = document.getElementById('send-chat-btn');
            const currentChatTitle = document.getElementById('current-chat-title');

            let currentRoomId = null;
            let currentSubscription = null;
            // ì „ì—­ stompClient ì‚¬ìš© (notifications.html í˜¹ì€ layoutì—ì„œ ì´ˆê¸°í™”ëœ ê²ƒ ê°€ì •)
            // ë§Œì•½ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ìƒˆë¡œ ì—°ê²° ë¡œì§ í•„ìš”í•˜ì§€ë§Œ, ë³´í†µ layoutì— í¬í•¨ë¨.
            // ì•ˆì „ì„ ìœ„í•´ ì—¬ê¸°ì„œ ì—°ê²° í™•ì¸ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥.

            function openChat(e) {
                e.preventDefault();
                chatOverlay.classList.add('active');
                chatSidebar.classList.add('active');
                showChatList();
                loadChatRooms();
            }

            function closeChat() {
                chatOverlay.classList.remove('active');
                chatSidebar.classList.remove('active');
                if (currentSubscription) {
                    currentSubscription.unsubscribe();
                    currentSubscription = null;
                }
                currentRoomId = null;
            }

            function showChatList() {
                chatListView.style.display = 'block';
                chatRoomView.style.display = 'none';
                if (currentSubscription) {
                    currentSubscription.unsubscribe();
                    currentSubscription = null;
                }
                currentRoomId = null;
            }

            function showChatRoom(roomName) {
                chatListView.style.display = 'none';
                chatRoomView.style.display = 'flex'; // flexë¡œ ì„¤ì •í•´ì•¼ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ ìœ ì§€
                currentChatTitle.innerText = roomName || 'ì±„íŒ…ë°©';
            }

            function loadChatRooms() {
                chatListContent.innerHTML = '<p style="padding: 20px;">ë¡œë”© ì¤‘...</p>';
                fetch('/api/chat/rooms')
                    .then(response => {
                        if(response.status === 401) throw new Error('ë¡œê·¸ì¸ í•„ìš”');
                        return response.json();
                    })
                    .then(rooms => {
                        if (!rooms || rooms.length === 0) {
                            chatListContent.innerHTML = '<p style="padding: 20px;">ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                            return;
                        }
                        let html = '<div class="chat-room-list">';
                        rooms.forEach(room => {
                            // ìƒëŒ€ë°© ì´ë¦„ ì°¾ê¸° (ë‚´ê°€ buyerë©´ seller, sellerë©´ buyer)
                            // í˜„ì¬ ë‚´ ì •ë³´ê°€ JSì— ì—†ìœ¼ë¯€ë¡œ, í¸ì˜ìƒ ë‘˜ ë‹¤ í‘œì‹œí•˜ê±°ë‚˜ APIê°€ ê°€ê³µí•´ì„œ ì£¼ë©´ ì¢‹ìŒ.
                            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ product titleê³¼ ìƒëŒ€ë°© ì •ë³´ë¥¼ ì¡°í•©.
                            // *ì‹¤ì œë¡œëŠ” currentUserIdê°€ í•„ìš”í•¨.
                            // ì„ì‹œë¡œ user info ì—†ì´ ìƒí’ˆëª… ìœ„ì£¼ë¡œ í‘œì‹œ
                            let roomName = room.product ? room.product.title : 'ì•Œ ìˆ˜ ì—†ëŠ” ìƒí’ˆ';
                            
                            html += `
                                <div class="chat-room-item" data-room-id="${room.id}" data-room-name="${roomName}">
                                    <div class="chat-room-title">${roomName}</div>
                                    <div class="chat-room-info">
                                        <span>${room.buyer ? room.buyer.nickname : 'êµ¬ë§¤ì'} / ${room.seller ? room.seller.nickname : 'íŒë§¤ì'}</span>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        chatListContent.innerHTML = html;

                        // í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                        document.querySelectorAll('.chat-room-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const roomId = this.getAttribute('data-room-id');
                                const roomName = this.getAttribute('data-room-name');
                                enterChatRoom(roomId, roomName);
                            });
                        });
                    })
                    .catch(err => {
                        console.error(err);
                        if(err.message === 'ë¡œê·¸ì¸ í•„ìš”') {
                            chatListContent.innerHTML = '<p style="padding: 20px;"><a href="/users/login">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”.</p>';
                        } else {
                            chatListContent.innerHTML = '<p style="padding: 20px;">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</p>';
                        }
                    });
            }

            function enterChatRoom(roomId, roomName) {
                currentRoomId = roomId;
                showChatRoom(roomName);
                chatMessagesArea.innerHTML = '<p style="padding: 10px; text-align: center; color: #999;">ëŒ€í™” ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
                
                // 1. Load Messages
                fetch('/api/chat/messages/' + roomId)
                    .then(res => res.json())
                    .then(messages => {
                        chatMessagesArea.innerHTML = ''; // ì´ˆê¸°í™”
                        messages.forEach(msg => {
                            appendMessage(msg);
                        });
                        scrollToBottom();
                    });

                // 2. Subscribe WebSocket
                if (typeof stompClient !== 'undefined' && stompClient && stompClient.connected) {
                    currentSubscription = stompClient.subscribe('/topic/chat/room/' + roomId, function(message) {
                        const msgBody = JSON.parse(message.body);
                        appendMessage(msgBody);
                        scrollToBottom();
                    });
                } else {
                    console.error("WebSocket is not connected.");
                    // ì¬ì—°ê²° ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
                }
            }

            function appendMessage(msg) {
                const div = document.createElement('div');
                // ë‚´ ë©”ì‹œì§€ì¸ì§€ êµ¬ë¶„í•˜ë ¤ë©´ currentUserId í•„ìš”.
                // ì„ì‹œë¡œ: ë‚´ê°€ ë³´ë‚¸ê±´ì§€ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ëª¨ë‘ 'other-message' ì²˜ëŸ¼ ë³´ì´ê±°ë‚˜
                // ë©”ì‹œì§€ì— sender ì •ë³´ê°€ ìˆìœ¼ë‹ˆ ê·¸ê²ƒì„ í‘œì‹œ.
                // * ê°œì„ ì : APIê°€ isMine í•„ë“œë¥¼ ì£¼ê±°ë‚˜ HTMLì— currentUserIdë¥¼ ë°•ì•„ë‘¬ì•¼ í•¨.
                // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì™¼ìª½ì— ë„ìš°ë˜, ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„ì„ í‘œì‹œ.
                
                div.className = 'message-bubble other-message'; 
                // ë§Œì•½ msg.sender === myNickname (JSë³€ìˆ˜í•„ìš”) ì´ë©´ 'my-message' ì¶”ê°€
                
                div.innerHTML = `
                    <div class="message-sender">${msg.sender}</div>
                    ${msg.message}
                `;
                chatMessagesArea.appendChild(div);
            }

            function sendMessage() {
                const text = chatInput.value.trim();
                if(!text || !currentRoomId) return;

                // ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°: í—¤ë”ì— ìˆëŠ” user-info í™œìš©
                const userInfoSpan = document.querySelector('.user-info');
                const sender = userInfoSpan ? userInfoSpan.innerText : 'ìµëª…';

                const chatMessage = {
                    roomId: currentRoomId,
                    sender: sender,
                    message: text
                };

                if (typeof stompClient !== 'undefined' && stompClient && stompClient.connected) {
                    stompClient.send("/app/chat/message", {}, JSON.stringify(chatMessage));
                    chatInput.value = '';
                } else {
                    alert("ì±„íŒ… ì„œë²„ì™€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            }

            function scrollToBottom() {
                chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            if(chatBtn) chatBtn.addEventListener('click', openChat);
            if(closeChatBtn) closeChatBtn.addEventListener('click', closeChat);
            if(closeChatRoomBtn) closeChatRoomBtn.addEventListener('click', closeChat); // ë°©ì—ì„œ ë‹«ê¸° ëˆŒëŸ¬ë„ ì „ì²´ ë‹«ê¸°
            if(chatOverlay) chatOverlay.addEventListener('click', closeChat);
            if(backToChatListBtn) backToChatListBtn.addEventListener('click', showChatList);
            
            if(sendChatBtn) sendChatBtn.addEventListener('click', sendMessage);
            if(chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if(e.key === 'Enter') sendMessage();
                });
            }
        });
    </script>
</header>
</body>
</html>