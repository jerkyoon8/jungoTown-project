<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <title th:text="${product.title}"></title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/productDetail.css}">
    </th:block>
</head>

<main layout:fragment="content">
    <div class="product-detail-layout">

        <!-- 좌측: 이미지 영역 -->
        <section class="product-image-section">
            <img th:if="${!#lists.isEmpty(product.storedFileNames)}" th:src="@{/images/{filename}(filename=${product.storedFileNames[0]})}" alt="상품 대표 이미지">
            <img th:unless="${!#lists.isEmpty(product.storedFileNames)}" th:src="@{/image/placeholder.png}" alt="이미지 없음">
        </section>

        <!-- 우측: 정보 영역 -->
        <section class="product-details-section">
            <h2 class="product-title" th:text="${product.title}">상품 제목</h2>

            <div class="price" th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">34,000원</div>

            <div class="product-meta">
                <span th:text="${@timeTrace.calculateTime(product.createdAt)}"></span> |
                <span>조회 <th:block th:text="${product.views}"></th:block></span> |
                <span>찜 <th:block id="wishlist-count" th:text="${product.wishlistCount}"></th:block></span>
            </div>

            <div class="product-actions">
                <form id="wishlistForm" th:action="@{/wishlist/{id}(id=${product.id})}" method="post" style="display: contents;">
                    <button type="button" class="wish-btn like-button">♡</button>
                </form>
                <a th:if="${!isOwner}" th:href="@{/chat/room/{id}(id=${product.id})}" class="action-btn">채팅하기</a>
                <a href="#" class="action-btn purchase-btn">구매하기</a>
            </div>

            <div class="seller-info">
                <div class="avatar"></div>
                <div class="nickname" th:text="${product.author}">판매자 닉네임</div>
            </div>

            <ul class="product-extra-details">
                <li>
                    <span class="detail-label">상품상태</span>
                    <span class="detail-value">중고, 구성품 없음</span> <!-- 임시값 -->
                </li>
                <li>
                    <span class="detail-label">거래지역</span>
                    <span class="detail-value" th:text="${product.dealRegion}">서울시 강남구</span>
                </li>
                 <li>
                    <span class="detail-label">카테고리</span>
                    <span class="detail-value" th:text="${product.category != null ? product.category.name : '카테고리 없음'}"></span>
                </li>
            </ul>

            <div class="product-content" th:utext="${product.content}">
                상품 설명이 여기에 들어갑니다.
            </div>

            <!-- 수정/삭제 버튼 (소유자에게만 보임) -->
            <div th:if="${isOwner}" class="owner-actions">
                <a th:href="@{/products/{id}/edit(id=${product.id})}" class="button">수정</a>
                <form th:action="@{/products/{id}/delete(id=${product.id})}" method="post" style="display: inline;">
                    <button type="submit" class="button delete-button" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
                </form>
                 <a th:href="@{/products}" class="button">목록으로</a>
            </div>

        </section>
    </div>
</main>

<th:block layout:fragment="script">
    <script>
        // 찜하기 기능 (기존 스크립트 재사용)
        document.addEventListener('DOMContentLoaded', function() {
            const wishlistButton = document.querySelector('.like-button');
            const wishlistForm = document.getElementById('wishlistForm');

            if (wishlistButton && wishlistForm) {
                wishlistButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    const url = wishlistForm.action;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            // CSRF 토큰이 필요하다면 여기에 추가
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        const countElement = document.getElementById('wishlist-count');
                        const wishBtn = document.querySelector('.like-button');
                        if (countElement) {
                           // 성공 시 카운트 업데이트 로직 (예: data.wishlistCount)
                           countElement.textContent = data.wishlistCount;
                           if(data.wished) {
                               wishBtn.textContent = '❤️'; // 찜 추가됨
                           } else {
                               wishBtn.textContent = '♡'; // 찜 취소됨
                           }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // 로그인하지 않은 사용자의 경우 등 서버에서 보내는 에러 메시지를 alert
                        alert(error.message || '오류가 발생했습니다. 로그인 후 이용해주세요.');
                    });
                });
            }
        });
    </script>
</th:block>

</html>