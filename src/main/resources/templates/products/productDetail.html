<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default_layout}">

<head>
    <title th:text="${product.title}"></title>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/productDetail.css}">
    </th:block>
</head>

<main layout:fragment="content">
    <div class="product-detail-layout">

        <!-- 좌측: 이미지 영역 -->
        <section class="product-image-section">
            <img th:if="${!#lists.isEmpty(product.storedFileNames)}" th:src="@{/images/{filename}(filename=${product.storedFileNames[0]})}" alt="상품 대표 이미지">
            <img th:unless="${!#lists.isEmpty(product.storedFileNames)}" th:src="@{/image/placeholder.png}" alt="이미지 없음">
        </section>

        <!-- 우측: 정보 영역 -->
        <section class="product-details-section">
            <h2 class="product-title" th:text="${product.title}">상품 제목</h2>

            <div class="price" th:text="${#numbers.formatInteger(product.price, 0, 'COMMA') + '원'}">34,000원</div>

            <div class="product-meta">
                <span th:text="${@timeTrace.calculateTime(product.createdAt)}"></span> |
                <span>조회 <span th:text="${product.views}"></span></span> |
                <span>찜 <span id="wishlist-count" th:text="${product.wishlistCount}"></span></span>
            </div>

            <div class="product-actions">
                <form id="wishlistForm" th:action="@{/wishlist/{id}(id=${product.id})}" method="post" style="display: contents;">
                    <button type="button" class="wish-btn like-button"
                            th:classappend="${isWished} ? 'wished' : ''"
                            th:text="${isWished} ? '❤️' : '♡'">♡</button>
                </form>
                <a th:if="${canChat}" href="javascript:void(0)" th:onclick="'openChatRoom(' + ${product.id} + ')'" class="action-btn">채팅하기</a>
                <button type="button" class="action-btn purchase-btn" onclick="requestPay()">구매하기</button>
            </div>

            <div class="seller-info">
                <div class="avatar"></div>
                <div class="nickname" th:text="${product.author}">판매자 닉네임</div>
            </div>

            <ul class="product-extra-details">
                <li>
                    <span class="detail-label">상품상태</span>
                    <span class="detail-value">중고, 구성품 없음</span> <!-- 임시값 -->
                </li>
                <li>
                    <span class="detail-label">거래지역</span>
                    <span class="detail-value" th:text="${product.dealRegion}">서울시 강남구</span>
                </li>
                 <li>
                    <span class="detail-label">카테고리</span>
                    <span class="detail-value" th:text="${product.category != null ? product.category.name : '카테고리 없음'}"></span>
                </li>
            </ul>

            <div class="product-content" th:utext="${product.content}">
                상품 설명이 여기에 들어갑니다.
            </div>

            <!-- 수정/삭제 버튼 (소유자에게만 보임) -->
            <div th:if="${isOwner}" class="owner-actions">
                <a th:href="@{/products/{id}/edit(id=${product.id})}" class="button">수정</a>
                <form th:action="@{/products/{id}/delete(id=${product.id})}" method="post" style="display: inline;">
                    <button type="submit" class="button delete-button" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
                </form>
                 <a th:href="@{/products}" class="button">목록으로</a>
            </div>

        </section>
    </div>
</main>

<th:block layout:fragment="script">
    <!-- 포트원 V2 결제 라이브러리 -->
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    
    <script th:inline="javascript">
        // UUID 생성 함수 (구형 브라우저 호환성 고려)
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        async function requestPay() {
            // 1. 주문 생성 요청
            const productId = [[${product.id}]];
            const productName = [[${product.title}]];
            const productPrice = [[${product.price}]];
            const storeId = "store-16915d01-5081-4b4b-9ef7-468bc8f0d4fa"; // V2 Store ID
            const channelKey = "channel-key-d8393037-a807-4135-b601-0eb00f30d496"; // 실제 카카오페이 테스트 채널 키

            // 주문 생성 API 호출
            try {
                const orderRes = await fetch('/api/orders?productId=' + productId, { method: 'POST' });
                if (orderRes.status === 401) {
                    alert('로그인이 필요합니다.');
                    location.href = '/login';
                    return;
                }
                if (!orderRes.ok) throw new Error('주문 생성 실패');
                
                const merchantUid = await orderRes.text(); // 주문 ID (DB PK)
                const paymentId = 'payment-' + generateUUID(); // 결제 고유 ID (V2 필수)

                // 2. 포트원 결제 요청 (V2)
                const response = await PortOne.requestPayment({
                    storeId: storeId,
                    channelKey: channelKey, // *필수*: 콘솔에서 발급받은 채널 키
                    paymentId: paymentId,
                    orderName: productName,
                    totalAmount: productPrice,
                    currency: "CURRENCY_KRW",
                    payMethod: "EASY_PAY", // 카카오페이 등 간편결제
                    customer: {
                        // fullName: "홍길동",
                        // phoneNumber: "010-1234-5678",
                        // email: "test@test.com"
                    },
                    customData: {
                        orderId: merchantUid
                    }
                });

                // 3. 결제 응답 처리
                if (response.code != null) {
                    // 결제 실패 (code가 있으면 에러)
                    alert("결제 실패: " + response.message);
                    return;
                }

                // 4. 결제 성공 시 서버 검증
                // response.paymentId가 존재하면 성공으로 간주하고 서버 검증 시도
                const validationRes = await fetch("/api/payments/validation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        payment_uid: paymentId, // V2 paymentId
                        order_uid: merchantUid  // 주문 번호
                    })
                });

                if (!validationRes.ok) {
                    const errorText = await validationRes.text();
                    throw new Error(errorText);
                }

                alert("결제가 완료되었습니다!");
                location.reload();

            } catch (error) {
                console.error(error);
                alert("처리 중 오류가 발생했습니다: " + error.message);
            }
        }
        
        // 찜하기 기능
        document.addEventListener('DOMContentLoaded', function() {
            const wishlistButton = document.querySelector('.like-button');
            const wishlistForm = document.getElementById('wishlistForm');

            if (wishlistButton && wishlistForm) {
                wishlistButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    const url = wishlistForm.action;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            // CSRF 토큰이 필요하다면 여기에 추가
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                             if (response.status === 401) throw new Error('로그인이 필요합니다.');
                             return response.json().then(err => { throw new Error(err.message || '오류가 발생했습니다.'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        const countElement = document.getElementById('wishlist-count');
                        const wishBtn = document.querySelector('.like-button');
                        
                        if (data.wishlistCount !== undefined) {
                           countElement.textContent = data.wishlistCount;
                        }
                        
                        if (data.wished) {
                           wishBtn.textContent = '❤️';
                           wishBtn.classList.add('wished');
                        } else {
                           wishBtn.textContent = '♡';
                           wishBtn.classList.remove('wished');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(error.message || '오류가 발생했습니다. 로그인 후 이용해주세요.');
                    });
                });
            }
        });
    </script>
</th:block>

</html>