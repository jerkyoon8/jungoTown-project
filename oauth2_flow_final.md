# Google OAuth 2.0 흐름: 실행 순서와 클래스 역할

이 문서는 구글 소셜 로그인 과정의 `실행 순서`와, 이 과정에 관여하는 `주요 클래스의 역할`을 각각 나누어 설명합니다.

---

## 실행 순서

1.  사용자가 웹 브라우저에서 '구글 로그인' 링크(`http://localhost:8080/oauth2/authorization/google`)를 클릭합니다.

2.  **Spring Security**가 해당 요청을 감지하고, `application.properties`의 설정값을 기반으로 사용자를 구글의 인증 페이지로 리디렉션시킵니다.

3.  사용자는 구글 페이지에서 ID와 비밀번호를 입력하여 인증하고, 애플리케이션의 정보 접근 요청에 '동의'합니다.

4.  구글은 인증이 완료된 사용자를 `redirect-uri`로 다시 돌려보냅니다. 이때 URL에는 임시 `인증 코드(Authorization Code)`가 포함되어 있습니다.

5.  **Spring Security**가 `인증 코드`가 포함된 요청을 받아, 백그라운드에서 구글 인증 서버와 직접 통신하여 `액세스 토큰(Access Token)`으로 교환합니다.

6.  **Spring Security**는 발급받은 `액세스 토큰`을 사용해 구글의 리소스 서버(API)에 사용자 정보를 요청하여 받아옵니다.

7.  **Spring Security**는 최종적으로 개발자가 직접 구현한 **`CustomOAuth2UserService`**의 `loadUser` 메소드를 호출하며, 6단계에서 얻은 사용자 정보를 인자로 전달합니다.

8.  `loadUser` 메소드 내부에서는 받은 사용자 정보를 `OAuthAttributes`로 변환하고, `saveOrUpdate` 메소드를 호출하여 데이터베이스에 사용자를 조회하거나 새로 저장하는 작업을 수행합니다.

9.  DB 작업이 완료되면, 로그인 상태 유지를 위해 `SessionUser` 객체를 생성하여 `HttpSession`에 저장합니다.

10. `loadUser` 메소드가 Spring Security에 최종 인증 정보 객체를 반환하면, 모든 인증 과정이 종료되고 사용자는 로그인된 상태로 애플리케이션의 홈 페이지로 이동합니다.

---

## 주요 클래스 및 역할

- **`Spring Security`**
  - **역할**: OAuth 2.0의 전체적인 흐름을 관장하는 프레임워크. 필터 체인을 통해 로그인 요청을 감지하고, 리디렉션, 토큰 교환, API 호출 등 복잡한 과정을 자동화합니다. 최종적으로는 개발자가 만든 `CustomOAuth2UserService`를 호출하여 비즈니스 로직을 수행하도록 합니다.

- **`CustomOAuth2UserService`**
  - **역할**: **개발자가 실제 비즈니스 로직을 구현하는 가장 핵심적인 클래스.** Spring Security로부터 전달받은 사용자 정보를 가지고, 우리 애플리케이션의 데이터베이스에 해당 사용자를 저장하거나, 기존 사용자의 정보를 업데이트하는 등의 작업을 처리합니다.

- **`OAuthAttributes`**
  - **역할**: 데이터 전송 객체(DTO). 구글, 네이버 등 각기 다른 소셜 서비스가 제공하는 다양한 형태의 사용자 정보(JSON)를, 우리 시스템에서 통일된 형식으로 사용하기 위해 변환해주는 역할을 합니다.

- **`UserRepository`**
  - **역할**: 데이터 접근 객체(DAO). MyBatis와 연결되어 데이터베이스의 `user` 테이블에 직접적인 CRUD(생성, 조회, 수정, 삭제) 작업을 수행하는 인터페이스입니다. `saveOrUpdate` 메소드에서 사용자를 조회하거나 저장할 때 호출됩니다.

- **`User`**
  - **역할**: 도메인/엔티티 클래스. 데이터베이스 `user` 테이블의 한 행(row)과 직접적으로 매핑되는 객체입니다. 사용자의 모든 정보를 담고 있습니다.

- **`SessionUser`**
  - **역할**: 세션 저장용 데이터 전송 객체(DTO). `User` 클래스는 엔티티이므로 직렬화(Serialization) 관련 이슈가 발생할 수 있고, 모든 정보를 세션에 담기에는 너무 무겁습니다. 따라서 로그인한 사용자의 핵심 정보(이름, 이메일 등)만 따로 담아 `HttpSession`에 저장하는 가벼운 객체입니다.

- **`application.properties`**
  - **역할**: 설정 파일. OAuth 2.0 연동에 필요한 `client-id`, `client-secret`과 같은 민감한 정보와 `scope` 등의 설정값을 보관합니다. Spring Security는 이 파일의 정보를 기반으로 동작합니다.
